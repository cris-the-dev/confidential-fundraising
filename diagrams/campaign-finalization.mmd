---
config:
  look: handDrawn
  theme: neutral
---

sequenceDiagram
    participant U as ðŸ‘¤ Campaign Owner
    participant F as ðŸŽ¨ Frontend
    participant R as ðŸ” Relayer SDK
    participant CF as ðŸ“ ConfidentialFundraising
    participant SV as ðŸ’° ShareVault
    participant CT as ðŸª™ CampaignToken

    U->>F: Click "Finalize Campaign"
    F->>F: Check deadline passed

    rect rgb(255, 250, 240)
        Note over U,CF: v0.9 Self-Relaying Decryption (4 Steps)

        Note over F,CF: Step 1: Request Decryption
        F->>CF: requestTotalRaisedDecryption(campaignId)
        CF->>CF: FHE.makePubliclyDecryptable(totalRaised)
        CF->>CF: Set status = PROCESSING
        CF-->>F: âœ… Marked as decryptable

        Note over F,CF: Step 2: Get Encrypted Handle
        F->>CF: getEncryptedTotalRaised(campaignId)
        CF-->>F: encryptedHandle

        Note over F,R: Step 3: Public Decrypt with Proof
        F->>R: instance.publicDecrypt([handle])
        R->>R: Decrypt + generate proof
        R-->>F: { cleartext, proof }

        Note over F,CF: Step 4: Submit Proof
        F->>CF: submitTotalRaisedDecryption(campaignId, cleartext, proof)
        CF->>CF: FHE.checkSignatures(handle, cleartext, proof)
        CF->>CF: Cache cleartext, set status = DECRYPTED
        CF-->>F: âœ… Decryption verified & cached
    end

    F->>F: Display total to owner
    U->>F: Confirm finalization<br/>(provide token name & symbol)

    F->>CF: finalizeCampaign(campaignId, tokenName, tokenSymbol)
    CF->>CF: Read cached decrypted total

    alt Target Reached âœ…
        CF->>CT: Deploy new CampaignToken
        CT-->>CF: Token contract address

        loop For each contributor
            CF->>SV: transferLockedFunds(contributor, owner, campaignId)
            SV->>SV: Transfer locked funds to owner
            SV-->>CF: âœ… Funds transferred
        end

        CF->>CF: Mark campaign successful
        CF-->>F: âœ… Campaign finalized successfully
        F-->>U: "ðŸŽ‰ Campaign successful!<br/>Contributors can claim tokens"
    else Target Not Reached âŒ
        loop For each contributor
            CF->>SV: unlockFunds(contributor, campaignId)
            SV->>SV: Unlock funds back to available
            SV-->>CF: âœ… Funds unlocked
        end

        CF->>CF: Mark campaign failed
        CF-->>F: âŒ Campaign failed
        F-->>U: "Campaign failed.<br/>Refunds available to contributors"
    end
